/* ==========================================================================
   TEJ_JET COLDWALL v6.0.0 (Behavioral Trust Engine + AI Data Recorder)
   The Nervous System | Proprietary Security Protocol
   (c) 2026 Tej Reddy Systems.
   ========================================================================== */

(function(window, document) {

    // --- 1. CONFIGURATION ---
    const CONFIG = {
        productName: "TEJ_JET COLDWALL",
        trustScore: 100,
        thresholds: {
            suspicious: 70,
            danger: 40,
            ban: 0
        },
        decayRates: {
            rightClick: 20,
            devTools: 50,
            copyAttempt: 10,
            rapidClick: 5,
            roboticMouse: 15
        }
    };

    // --- 2. CLOUD CONFIGURATION ---
    // PASTE YOUR KEYS HERE
    const SUPABASE_URL = "https://dsadmqmdwcxcllhnsyga.supabase.co"; 
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzYWRtcW1kd2N4Y2xsaG5zeWdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MzI1NzQsImV4cCI6MjA4MzIwODU3NH0.0D8HCsZd5i_NUdYg35ZFmOGNMB5JEbzLA5rFOONOr1U";

    // --- 3. HELPER: REPORT ALERTS (Security Logs) ---
    async function reportThreat(reason, score) {
        console.warn(`[TEJ_JET AI] Trust Dropped. Score: ${score}. Reason: ${reason}`);
        if (!SUPABASE_URL || SUPABASE_URL.includes("PASTE_YOUR")) return;
        
        const logData = {
            domain: window.location.hostname,
            trigger_reason: `${reason} (Score: ${score})`,
            url_path: window.location.pathname,
            user_agent: navigator.userAgent,
            screen_resolution: `${window.screen.width}x${window.screen.height}`
        };

        try {
            await fetch(`${SUPABASE_URL}/rest/v1/security_logs`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` },
                body: JSON.stringify(logData)
            });
        } catch (e) {}
    }

    // --- 4. THE AI TRUST ENGINE ---
    class TrustEngine {
        constructor() {
            this.score = CONFIG.trustScore;
            
            // Heuristic Buffers (For immediate detection)
            this.clickHistory = [];
            this.mouseHistory = [];
            
            // Training Buffers (For AI Learning - Larger capacity)
            this.startTime = Date.now();
            this.rawMousePath = []; 
            
            this.lastActionTime = Date.now();
        }

        penalize(amount, reason) {
            this.score -= amount;
            if (this.score > 100) this.score = 100;
            
            // DECISION MATRIX
            if (this.score <= CONFIG.thresholds.ban) {
                this.executeBan();
            } else if (this.score <= CONFIG.thresholds.danger) {
                this.triggerWarning(reason);
                reportThreat(reason, this.score);
            } else if (this.score <= CONFIG.thresholds.suspicious) {
                reportThreat(reason, this.score);
            }
        }

        // --- DATA RECORDER (Saves to 'training_data' table) ---
        async saveSessionData(wasBanned) {
            if (!SUPABASE_URL || SUPABASE_URL.includes("PASTE")) return;

            // Calculate Session Stats
            const duration = Date.now() - this.startTime;
            
            // Calculate Click Variance for the report
            let clickVar = 0;
            let avgClick = 0;
            if (this.clickHistory.length > 1) {
                const intervals = [];
                for (let i = 1; i < this.clickHistory.length; i++) {
                    intervals.push(this.clickHistory[i] - this.clickHistory[i-1]);
                }
                avgClick = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                clickVar = intervals.reduce((a, b) => a + Math.pow(b - avgClick, 2), 0) / intervals.length;
            }

            const payload = {
                domain: window.location.hostname,
                session_duration_ms: duration,
                avg_click_interval_ms: avgClick || 0,
                click_variance: clickVar || 0,
                total_actions: this.clickHistory.length,
                final_trust_score: this.score,
                was_banned: wasBanned,
                // Send raw data (Last 50 events to save DB space)
                raw_click_data: this.clickHistory.slice(-50),
                raw_mouse_path: this.rawMousePath.slice(-50)
            };

            const url = `${SUPABASE_URL}/rest/v1/training_data?apikey=${SUPABASE_KEY}`;
            
            // Use Beacon API if possible (Reliable when tab is closing)
            if (navigator.sendBeacon) {
                const blob = new Blob([JSON.stringify(payload)], {type: 'application/json'});
                navigator.sendBeacon(url, blob);
            } else {
                fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` },
                    body: JSON.stringify(payload)
                });
            }
        }

        // --- HEURISTIC 1: Detect Robotic Clicking ---
        analyzeClick() {
            const now = Date.now();
            this.clickHistory.push(now);
            
            // Immediate Detection Logic (Last 5 clicks)
            if (this.clickHistory.length > 5) {
                // We don't shift here anymore so we can keep data for training, 
                // but we only analyze the last 5 for the penalty check.
                const recentClicks = this.clickHistory.slice(-6);
                const intervals = [];
                for (let i = 1; i < recentClicks.length; i++) {
                    intervals.push(recentClicks[i] - recentClicks[i-1]);
                }
                const average = intervals.reduce((a, b) => a + b) / intervals.length;
                const variance = intervals.reduce((a, b) => a + Math.pow(b - average, 2), 0) / intervals.length;

                if (average < 150 && variance < 50) {
                    this.penalize(CONFIG.decayRates.rapidClick, "AI: Robotic Click Rhythm Detected");
                }
            }
        }

        // --- HEURISTIC 2: Detect Linear Mouse Movement ---
        trackMouse(e) {
            // Add to short-term buffer for detection
            this.mouseHistory.push({x: e.clientX, y: e.clientY});
            
            // Add to long-term buffer for AI Training
            this.rawMousePath.push({x: e.clientX, y: e.clientY, t: Date.now()});
            if (this.rawMousePath.length > 100) this.rawMousePath.shift(); // Keep last 100 for training

            if (this.mouseHistory.length > 20) {
                this.mouseHistory.shift();
                
                let straightLines = 0;
                for (let i = 2; i < this.mouseHistory.length; i++) {
                    const prev = this.mouseHistory[i-2];
                    const curr = this.mouseHistory[i];
                    if (Math.abs(curr.x - prev.x) > 50 && Math.abs(curr.y - prev.y) === 0) straightLines++;
                    if (Math.abs(curr.y - prev.y) > 50 && Math.abs(curr.x - prev.x) === 0) straightLines++;
                }

                if (straightLines > 5) {
                    this.penalize(CONFIG.decayRates.roboticMouse, "AI: Unnatural Mouse Movement");
                    this.mouseHistory = []; 
                }
            }
        }

        triggerWarning(reason) {
            const existing = document.getElementById('tj-alert');
            if (existing) return;
            const modal = document.createElement('div');
            modal.id = 'tj-alert';
            modal.style = "position: fixed; bottom: 20px; right: 20px; z-index: 999999; background: #220000; border-left: 4px solid #f00; color: #fff; padding: 15px; font-family: sans-serif; box-shadow: 0 5px 15px rgba(0,0,0,0.5);";
            modal.innerHTML = `<strong style="color: #f00;">‚ö†Ô∏è SUSPICIOUS ACTIVITY</strong><br><div style="font-size: 12px; margin-top: 5px; color: #aaa;">Trust Score: ${this.score}/100</div><div style="font-size: 11px; margin-top: 5px;">Analysis: ${reason}</div>`;
            document.body.appendChild(modal);
            setTimeout(() => modal.remove(), 4000);
        }

        async executeBan() {
            console.log("üö´ BAN TRIGGERED! Saving evidence...");
            
            // 1. FORCE SAVE (Await ensures we wait for it to start)
            // We use a small trick: We don't await the fetch fully (which takes time),
            // but we ensure the request is queued before killing the UI.
            await this.saveSessionData(true); 
            
            // Small delay to let the network packet escape the browser (100ms)
            await new Promise(r => setTimeout(r, 100));

            // 2. NOW Kill the page
            try { window.stop(); } catch(e){}
            
            document.documentElement.innerHTML = `
                <div style="height:100vh; background:#000; color:#f00; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family:monospace;">
                    <h1 style="font-size:48px;">CONNECTION SEVERED</h1>
                    <p>TEJ_JET AI: BEHAVIORAL THREAT DETECTED</p>
                    <p style="color:#666; margin-top:20px;">TRUST SCORE: 0</p>
                    <p style="color:#333; font-size: 10px; margin-top:50px;">INCIDENT LOGGED TO CLOUD</p>
                </div>
            `;
            
            // 3. Freeze the JS execution
            throw new Error("TEJ_JET: Banned.");
        }
    }

    // --- 5. INITIALIZE SYSTEM ---
    const AI = new TrustEngine();

    // Attach Sensors
    document.addEventListener('contextmenu', (e) => { e.preventDefault(); AI.penalize(CONFIG.decayRates.rightClick, "Right Click"); });
    document.addEventListener('keydown', (e) => {
        if(e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
            e.preventDefault();
            AI.penalize(CONFIG.decayRates.devTools, "DevTools Access");
        }
    });
    document.addEventListener('copy', () => { AI.penalize(CONFIG.decayRates.copyAttempt, "Clipboard Theft"); });

    // High-Frequency Sensors
    document.addEventListener('click', () => AI.analyzeClick());
    document.addEventListener('mousemove', (e) => AI.trackMouse(e));

    // --- 6. ATTACH DATA SAVER ---
    // Save data when the user closes the tab or navigates away
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden') {
            AI.saveSessionData(AI.score <= 0);
        }
    });

    console.log("%c TEJ_JET AI [WATCHING] ", "background: #000; color: #0f0;");

})(window, document);